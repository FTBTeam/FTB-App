stages:
    - build
    - build_app
    - packaging

variables:
    GRADLE_OPTS: "-Dorg.gradle.daemon=false"

build_jar:
    stage: build
    image: gradle:7.3.2-jdk17
    interruptible: true
    dependencies: []
    tags:
        - linux-aarch64
    script:
        - cd subprocess
        - export GRADLE_USER_HOME=.gradle
        - gradle clean build -si
    artifacts:
        paths:
            - subprocess/build/libs/
    cache:
        key: ftb-app-gradle
        paths:
            - subprocess/.gradle

cache_node:
    stage: build
    image: node:18
    interruptible: false
    dependencies: []
    tags:
        - linux-aarch64
    script:
        - npm install --global yarn || true
        - yarn install
    cache:
        key: ftb-app-frontend
        paths:
            - node_modules/

# TODO build shim step
build_overwolf:
    stage: build_app
    image: node:18
    tags:
        - linux-aarch64
    interruptible: true
    dependencies:
        - build_jar
    cache:
        key: ftb-app-frontend
        policy: pull
        paths:
            - node_modules/
    script:
        - cp subprocess/build/libs/version.json public/version.json
        - npm install --global yarn || true
        - yarn install
        - yarn gen:license
        - node overwolf/patchManifest.js
        - yarn vue:build:overwolf
        - node overwolf/packageOpk.js
    artifacts:
        paths:
            - overwolf/*.opk

build_electron:
    stage: build_app
    image: node:18
    tags:
        - linux-aarch64
    interruptible: true
    dependencies:
        - build_jar
    cache:
        key: ftb-app-frontend
        policy: pull
        paths:
            - node_modules/
    script:
        - cp subprocess/build/libs/version.json public/version.json
        - npm install --global yarn || true
        - yarn install
        - yarn gen:license
        - yarn build:electron
    artifacts:
        expire_in: 2 days
        paths:
            - release/ftbapp-linux.zip
            - release/ftbapp-mac.zip

electron_install4j:
    stage: packaging
    tags:
        - shell
    interruptible: true
    dependencies:
        - build_jar
        - build_electron
    variables:
        GIT_STRATEGY: clone
    script:
        - cd release
        - mkdir linux-unpacked mac
        - unzip ftbapp-linux.zip -d linux-unpacked
        - unzip ftbapp-mac.zip -d mac
        - cd ../subprocess
        - rm -rf releaseBuild
        - 'export VERSION=`jq -r .jarVersion build/libs/version.json`'
        - 'export BRANCH=`jq -r .branch build/libs/version.json`'
        - /Applications/install4j.app/Contents/Resources/app/bin/install4jc -L $INSTALL4J_LICENSE
        - /Applications/install4j.app/Contents/Resources/app/bin/install4jc --disable-signing --mac-keystore-password $INSTALL4J_APPLE_KEYSTORE_PASSWORD --apple-id-password $INSTALL4J_APPLE_ID_PW -r $VERSION -D branch=$BRANCH ftbapp.install4j
