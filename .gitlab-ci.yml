stages:
    - build
    - build_app
    - packaging

variables:
    GRADLE_OPTS: "-Dorg.gradle.daemon=false"

build_jar:
    stage: build
    image: gradle:7.3.2-jdk17
    interruptible: true
    dependencies: []
    tags:
        - linux-aarch64
    script:
        - cd subprocess
        - export GRADLE_USER_HOME=.gradle
        - gradle clean build -si
    artifacts:
        paths:
            - subprocess/build/libs/
    cache:
        key: ftb-app-gradle
        paths:
            - subprocess/.gradle

cache_node:
    stage: build
    image: node:18
    interruptible: false
    dependencies: []
    tags:
        - linux-aarch64
    script:
        - npm install --global pnpm || true
        - pnpm config set store-dir .pnpm-store
        - pnpm install
        - pnpm prune
    cache:
        key: ftb-app-pnpm
        paths:
            - .pnpm-store/

# TODO build shim step
build_overwolf:
    stage: build_app
    image: node:18
    tags:
        - linux-aarch64
    interruptible: true
    dependencies:
        - build_jar
    cache:
        key: ftb-app-pnpm
        policy: pull
        paths:
            - .pnpm-store/
    before_script:
        - npm install --global pnpm || true
        - pnpm config set store-dir .pnpm-store
    script:
        - cp subprocess/build/libs/version.json public/version.json
        - pnpm install
        - pnpm gen:license
        - node overwolf/patchManifest.js
        - pnpm vue:build:overwolf
        - node overwolf/packageOpk.js
    artifacts:
        paths:
            - overwolf/*.opk

build_electron:
    stage: build_app
    image: node:18
    tags:
        - linux-aarch64
    interruptible: true
    dependencies:
        - build_jar
    cache:
        key: ftb-app-pnpm
        policy: pull
        paths:
            - .pnpm-store/
    before_script:
        - apt update && apt install zip
        - npm install --global pnpm || true
        - pnpm config set store-dir .pnpm-store
    script:
        - cp subprocess/build/libs/version.json public/version.json
        - pnpm install
        - pnpm gen:license
        - pnpm build:electron
        - cd release
        - zip -r linux-unpacked.zip linux-unpacked
        - zip -r mac.zip mac
    artifacts:
        expire_in: 2 days
        paths:
            - release/linux-unpacked.zip
            - release/mac.zip

electron_install4j:
    stage: packaging
    tags:
        - shell
    interruptible: true
    dependencies:
        - build_jar
        - build_electron
    variables:
        GIT_STRATEGY: clone
    script:
        - cd release
        - unzip linux-unpacked.zip
        - unzip mac.zip
        - cd ../subprocess
        - rm -rf releaseBuild
        - 'export VERSION=`jq -r .jarVersion build/libs/version.json`'
        - 'export BRANCH=`jq -r .branch build/libs/version.json`'
        - /Applications/install4j.app/Contents/Resources/app/bin/install4jc -L $INSTALL4J_LICENSE
        - /Applications/install4j.app/Contents/Resources/app/bin/install4jc --disable-signing --mac-keystore-password $INSTALL4J_APPLE_KEYSTORE_PASSWORD --apple-id-password $INSTALL4J_APPLE_ID_PW -r $VERSION -D branch=$BRANCH ftbapp.install4j
